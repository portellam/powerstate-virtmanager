#!/bin/bash

#
# Filename:       powerstate-virtmanager.sh
# Version:        1.0.0-alpha
# Description:    Set the power state of a QEMU/KVM Virtual Machine (VM).
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# sources
#
  SCRIPT_DIR="$( \
      cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd \
    )/powerstate-virtmanager.d"

  # shellcheck source=./script-dialog
  source "${SCRIPT_DIR}"/script-dialog

#
# params
#
  SCRIPT_FILE="pwrstate-virtman-script-dialog.sh"
  LOG_FILE="/var/log/${SCRIPT_FILE}.log"
  APP_NAME="Power State VM Manager"

  #GUI=false; terminal=false  # force relaunching as if launching from GUI without
                              # a GUI interface installed, but only do this for
                              # testing

  #NOSYMBOLS=true
  #NOCOLORS=true

  readonly MAX_LIST_SIZE=5  # boxes currently have issues with lists greater
                            # than 5.

#
# logic
#
  function main
  {
    local domain=""

    if ! is_user_root \
      || ! prompt_virtual_machines "domain" \
      || ! prompt_power_states "${domain}"; then
      return 1
    fi

    return 0
  }

  function is_user_root
  {
    if [[ $( whoami ) != "root" ]]; then
      message-error "User is not root."
      return 1
    fi

    return 0
  }

  function prompt_power_states
  {
    local selected_domain="${1}"

    if [[ "${selected_domain}" == "" ]]; then
      message-error "Invalid virtual machine selected."
      return 1
    fi

    local domain_state="$( \
      sudo virsh domstate "${selected_domain}" | head --lines 1 \
    )"

    local -ir choice_count=9

    ACTIVITY="POWER STATES"

    # ANSWER=$( \
    #   radiolist "Set Power State for ${selected_domain}" "${choice_count}"  \
    #     "Start"         "Resume any suspended state."           OFF \
    #     "Pause"         "Suspend state."                        OFF \
    #     "Sleep"         "Suspend to Memory (S3)"                OFF \
    #     "Hibernate"     "Suspend to Disk (S4)"                  OFF \
    #     "Hybrid Sleep"  "Sleep and Hibernate"                   OFF \
    #     "Reboot"        "Stop and start."                       OFF \
    #     "Stop"          "Suspend power (S5)."                   OFF \
    #     "Reset"         "Force stop and start."                 OFF \
    #     "Force Stop"    "Force suspend power (S5)."             OFF
    # )

    ANSWER=$( \
      radiolist "Set Power State for ${selected_domain}" "${MAX_LIST_SIZE}"  \
        "Start"         "Resume any suspended state."           OFF \
        "Pause"         "Suspend state."                        OFF \
        "Sleep"         "Suspend to Memory (S3)"                OFF \
        "Hibernate"     "Suspend to Disk (S4)"                  OFF \
        "Hybrid Sleep"  "Sleep and Hibernate"                   OFF \
        "Reboot"        "Stop and start."                       OFF \
        "Stop"          "Suspend power (S5)."                   OFF \
        "Reset"         "Force stop and start."                 OFF \
        "Force Stop"    "Force suspend power (S5)."             OFF
    )

    local -Ar power_states_and_choice=(
      ["start"]="start --domain"
      ["resume"]="resume --domain"
      ["wake"]="dompmwakeup --domain"
      ["pause"]="suspend --domain"
      ["sleep"]="dompmsuspend --target mem"
      ["hibernate"]="dompmsuspend --target disk"
      ["hybrid sleep"]="dompmsuspend --target hybrid"
      ["reboot"]="reboot --domain"
      ["stop"]="shutdown --domain"
      ["reset"]="reset --domain"
      ["force stop"]="destroy --domain"
    )

    local -Ar power_states_and_status=(
      ["start"]="running"
      ["pause"]="paused"
      ["sleep"]="pmsuspended"
      ["hibernate"]="shut off"
      ["hybrid sleep"]="pmsuspended"
      ["stop"]="shut off"
      ["force stop"]="shut off"
    )

    ANSWER="${ANSWER,,}"  # to lowercase.
    local option=""

    case "${ANSWER}" in
      "pause" \
        | "sleep" \
        | "hibernate" \
        | "hybrid sleep" \
        | "stop" \
        | "force stop" \
      )
        if [[ "${domain_state}" != "${power_states_and_status["start"]}" ]]; then
          message-warn "Cannot stop \"${selected_domain}\".\nVirtual Machine is online."

          return 1
        fi
        ;;

      "reboot" \
        | "reset" \
      )
        if [[ "${domain_state}" != "${power_states_and_status["start"]}" ]]; then
          message-warn "Cannot restart \"${selected_domain}\".\nVirtual Machine is offline."

          return 1
        fi
        ;;

      "start" )
        if [[ "${domain_state}" == "${power_states_and_status["start"]}" ]]; then
          message-warn "Cannot start \"${selected_domain}\".\nVirtual Machine is online."

          return 1
        fi

        case "${domain_state}" in
          "${power_states_and_status["pause"]}" )
            ANSWER="resume"
            ;;

          "${power_states_and_status["stop"]}" )
            ANSWER="start"
            ;;

          "${power_states_and_status["sleep"]}" )
            ANSWER="wake"
            ;;
        esac
        ;;

      "" )
        message-error "No power state selected."
        return 1
        ;;
    esac

    local verb=""

    case "${ANSWER}" in
      "start" )
        verb="Started"
        ;;
      "resume" )
        verb="Resuming"
        ;;
      "wake" )
        verb="Waking"
        ;;
      "pause" )
        verb="Pausing"
        ;;
      "sleep" )
        verb="Sleeping"
        ;;
      "hibernate" )
        verb="Hibernating"
        ;;
      "hybrid sleep" )
        verb="Hybrid sleeping"
        ;;
      "reboot" )
        verb="Rebooting"
        ;;
      "reset" )
        verb="Reseting"
        ;;
      "stop" )
        verb="Stopping"
        ;;
      "force stop" )
        verb="Force stopping"
        ;;
    esac

    option="${power_states_and_choice["${ANSWER}"]}"

    if [[ "${option}" == "" ]]; then
      message-error "Unsupported power state '${ANSWER}'."
      return 1
    fi



    local set_domain_power_state="sudo virsh ${option} ${selected_domain}"
    local output=""

    if ! eval "${set_domain_power_state}" | output="${@}"; then
      # output="$( echo "${output}" | sort --reverse | head --lines 1 )"
      message-error "Failed to ${ANSWER} ${selected_domain}.\n${output}"
      echo "${output}"
      return 1
    else
      message-info "${verb} ${selected_domain}."
    fi

    return 0
  }

  function get_action_verb
  {
    local option=""
  }

  function prompt_virtual_machines
  {
    local -n reference="${1}"
    ACTIVITY="VIRTUAL MACHINES"

    local -ir max_index="$( sudo virsh list --all --name | head | wc --lines )"

    if [[ "${max_index}" -eq 0 ]]; then
      message-warn "No Virtual Machines exist."
      return 1
    fi

    #dialog_to_evaluate="radiolist \"Select a Virtual Machine\" \"${max_index}\""
    dialog_to_evaluate="radiolist \"Select a Virtual Machine\" \"${MAX_LIST_SIZE}\""
    local -i index=1

    for domain in $( sudo virsh list --all --name | head ); do
      local domain_state="$( \
        sudo virsh domstate "${domain}" | head --lines 1 \
      )"

      dialog_to_evaluate+=" \\ \"${index}. ${domain}\" \"${domain_state}\" OFF"
      (( index++ ))
    done

    ANSWER=$( eval "${dialog_to_evaluate}" )
    local selected_index="$( echo "${ANSWER}" | cut --delimiter '.' --fields 1 )"

    if [[ "${selected_index}" == "" ]]; then
      message-error "No virtual machine selected."
      return 1
    fi

    local selected_domain="$( \
      sudo virsh list --all --name | sed -n "${selected_index}p" \
    )"

    if [[ ${selected_domain} == "" ]]; then
      message-error "Invalid virtual machine selected."
      return 1
    fi

    reference="${selected_domain}"
    return 0
  }

#
# main
#
  #relaunch-if-not-visible
  main